<?xml version="1.0" encoding="utf-8"?>
<tool id="rnachipintegrator_wrapper" name="RnaChipIntegrator" version="@VERSION@-0">
  <description>Integrated analysis of gene expression data and ChIP data</description>
  <macros>
    <import>rnachipintegrator_macros.xml</import>
  </macros>
  <expand macro="requirements" />
  <expand macro="version_command" />
  <command interpreter="bash"><![CDATA[
  rnachipintegrator_wrapper.sh
  #if $peaks_in.metadata.chromCol
    --peak_cols=${peaks_in.metadata.chromCol},${peaks_in.metadata.startCol},${peaks_in.metadata.endCol}
  #end if
  #if str( $cutoff ) != ""
    --cutoff=$cutoff
  #else
    --cutoff=0
  #end if
  #if str( $number ) != ""
    --number=$number
  #else
    --number=0
  #end if
  --promoter_region=$promoter_start,$promoter_end
  --edge=$edge
  #if $features.set_feature_type
    --feature=$features.feature_type
  #end if
  $diff_expressed_only
  --xls_file "$xls_out"
  #if $results_as_zip
    --zip_file "$zip_file"
  #else
    --output_files "$peaks_per_feature_out" "$features_per_peak_out"
    #if str( $output.output_format ) == "full"
      --summary_files "$peaks_per_feature_summary" "$features_per_peak_summary"
      ${output.pad_output}
    #else
      --compact
    #end if
  #end if
  "$features_in" "$peaks_in"
  ]]></command>
  <inputs>
    <param format="tabular" name="features_in" type="data"
	   label="Genomic features (e.g. gene expression data)" />
    <param format="tabular" name="peaks_in" type="data"
	   label="Peaks" />
    <expand macro="analysis_options" />
    <param name="diff_expressed_only" type="boolean"
	   truevalue="--only-DE" falsevalue="" checked="false"
	   label="Only consider genomic features which are flagged as
		  differentially expressed"
           help="NB input feature data must include differential expression
		 flags (--only-DE)" />
    <expand macro="output_options" />
  </inputs>
  <outputs>
    <!-- Always produce XLS output -->
    <data format="xls" name="xls_out"
	  label="All RnaChipIntegrator analyses: ${features_in.name} vs ${peaks_in.name} (Excel spreadsheet)" />
    <!-- Outputs if no zip requested -->
    <data format="tabular" name="peaks_per_feature_out"
	  label="Nearest peaks to each feature: ${features_in.name} vs ${peaks_in.name}" >
      <filter>results_as_zip is False</filter>
    </data>
    <data format="tabular" name="features_per_peak_out"
	  label="Nearest features to each peak: ${features_in.name} vs ${peaks_in.name}" >
      <filter>results_as_zip is False</filter>
    </data>
    <data format="tabular" name="peaks_per_feature_summary"
	  label="Nearest peaks to each feature (summary): ${features_in.name} vs ${peaks_in.name}" >
      <filter>results_as_zip is False</filter>
      <filter>output_format == "full"</filter>
    </data>
    <data format="tabular" name="features_per_peak_summary"
	  label="Nearest features to each peak (summary): ${features_in.name} vs ${peaks_in.name}" >
      <filter>results_as_zip is False</filter>
      <filter>output_format == "full"</filter>
    </data>
    <!-- All outputs in a ZIP file -->
    <data format="zip" name="zip_file"
	  label="All tab-delimited files for ${features_in.name} vs ${peaks_in.name} (zip file)" >
      <filter>results_as_zip is True</filter>
    </data>
  </outputs>
  <tests>
    <!--
	RnaChipIntegrator +name=test +cutoff=130000 +promoter_region=-10000,2500 +xls +summary features.txt summits.txt
    -->
    <test>
      <param name="features_in" value="features.txt" ftype="tabular" />
      <param name="peaks_in" value="summits.txt" ftype="tabular" />
      <param name="cutoff" value="130000" />
      <param name="promoter_start" value="-10000" />
      <param name="promoter_end" value="2500" />
      <output name="xls_out" file="summits.xls" compare="sim_size" />
      <output name="peaks_per_feature_out" ftype="tabular"
	      file="summits_per_feature.out" />
      <output name="features_per_peak_out" ftype="tabular"
	      file="features_per_summit.out" />
      <output name="peaks_per_feature_summary" ftype="tabular"
	      file="summits_per_feature.summary" />
      <output name="features_per_peak_summary" ftype="tabular"
	      file="features_per_summit.summary" />
    </test>
    <!--
	RnaChipIntegrator +name=test +cutoff=130000 +promoter_region=-10000,2500 +xls +summary features.txt peaks.txt
    -->
    <test>
      <param name="features_in" value="features.txt" ftype="tabular" />
      <param name="peaks_in" value="peaks.txt" ftype="tabular" />
      <param name="cutoff" value="130000" />
      <param name="promoter_start" value="-10000" />
      <param name="promoter_end" value="2500" />
      <output name="xls_out" file="peaks1.xls" compare="sim_size" />
      <output name="peaks_per_feature_out" ftype="tabular"
	      file="peaks_per_feature1.out" />
      <output name="features_per_peak_out" ftype="tabular"
	      file="features_per_peak1.out" />
      <output name="peaks_per_feature_summary" ftype="tabular"
	      file="peaks_per_feature1.summary" />
      <output name="features_per_peak_summary" ftype="tabular"
	      file="features_per_peak1.summary" />
    </test>
    <!--
	RnaChipIntegrator +name=test +cutoff=130000 +xls +compact features.txt peaks.txt
    -->
    <test>
      <param name="features_in" value="features.txt" ftype="tabular" />
      <param name="peaks_in" value="peaks.txt" ftype="tabular" />
      <param name="cutoff" value="130000" />
      <param name="output_format" value="compact" />
      <output name="xls_out" file="peaks2.xls" compare="sim_size" />
      <output name="peaks_per_feature_out" ftype="tabular"
	      file="peaks_per_feature2.out" />
      <output name="features_per_peak_out" ftype="tabular"
	      file="features_per_peak2.out" />
    </test>
    <!--
	RnaChipIntegrator +name=test +cutoff=130000 +only-DE +feature=gene +xls +compact features.txt peaks.txt
    -->
    <test>
      <param name="features_in" value="features.txt" ftype="tabular" />
      <param name="peaks_in" value="peaks.txt" ftype="tabular" />
      <param name="cutoff" value="130000" />
      <param name="diff_expressed_only" value="true" />
      <param name="set_feature_type" value="true" />
      <param name="feature_type" value="gene" />
      <param name="output_format" value="compact" />
      <output name="xls_out" file="peaks3.xls" compare="sim_size" />
      <output name="peaks_per_feature_out" ftype="tabular"
	      file="peaks_per_feature3.out" />
      <output name="features_per_peak_out" ftype="tabular"
	      file="features_per_peak3.out" />
    </test>
  </tests>
  <help>

.. class:: infomark

**What it does**

Performs integrated analyses of genomic features (e.g. gene expression
data) against a set of peaks (e.g. ChIP data), identifying the nearest
peaks to each feature and vice versa.

The program was originally written specifically for ChIP-Seq and RNA-Seq
data but works equally well for ChIP-chip and microarray expression data,
and can also be used to integrate any set of genomic features (e.g.
canonical genes, CpG islands) with expression data.

RnaChipIntgerator can be obtained from
http://fls-bioinformatics-core.github.com/RnaChipIntegrator/

-------------

.. class:: infomark

**Input**

The feature data must be in a tabular file with the following columns
of data for each genomic feature (one feature per line):

====== ========== ======================================================================
Column Name       Description
====== ========== ======================================================================
     1 ID         Name used to identify the feature in the output
     2 chr        Chromosome name
     3 start      Start position of the feature
     4 end        End position of the feature
     5 strand     Must be either '+' or '-'
     6 diff_expr  Optional: indicates feature is differentially expressed (1) or not (0)
====== ========== ======================================================================

The peak data must be in a tabular file with at least 3 columns of data
for each peak (one peak per line):

====== ========== ======================================================================
Column Name       Description
====== ========== ======================================================================
     1 chr        Chromosome name (must match one of those in expression data file)
     2 start      Start position of the peak 
     3 end        End position of the peak (start + 1 for summit data)
====== ========== ======================================================================

If peak data is in ``bed`` format then the tool will automatically
assign the correct columns, otherwise the first three columns of data
will be used.

-------------

.. class:: infomark

**Outputs**

The key outputs from the tool are two lists compromising the nearest
peaks for each feature, and the nearest feature for each peak (one
dataset for each list).

There are two formats for reporting: "full" and "compact":

 * **Full output** reports the most extensive data for each feature-peak
   pair, with one pair reported per line in the output datasets.
 * **Compact output** reports minimal data, with multiple peaks for a
   given feature on a single line (and vice versa).

In "full" output mode, "summary" datasets are also produced with just
the top peak reported for each feature (and vice versa).

In either mode these data will also be output in a single MS Excel file,
which contains one sheet per result set.

-------------

.. class:: informark

**More information**

It is recommended that you refer to the ``RnaChipIntegrator``
documentation for information on the contents of each output file:
https://github.com/fls-bioinformatics-core/RnaChipIntegrator/blob/master/doc/MANUAL.markdown

-------------

.. class:: infomark

**Credits**

This Galaxy tool has been developed within the Bioinformatics Core Facility at the
University of Manchester. It runs the RnaChipIntegrator package which has also been
developed by this group, and is documented at
http://fls-bioinformatics-core.github.com/RnaChipIntegrator/

Please kindly acknowledge the Bioinformatics Core Facility if you use this tool.
  </help>
  <expand macro="citations" />
</tool>
