<tool id="rnachipintegrator_canonical_genes" name="Analyse canonical genes against ChIP data" version="@VERSION@-0">
  <description>using RnaChipIntegrator</description>
  <macros>
    <import>rnachipintegrator_macros.xml</import>
  </macros>
  <expand macro="requirements" />
  <expand macro="version_command" />
  <command interpreter="bash"><![CDATA[
  rnachipintegrator_wrapper.sh
  #if $peaks_in.metadata.chromCol
    --peak_cols=${peaks_in.metadata.chromCol},${peaks_in.metadata.startCol},${peaks_in.metadata.endCol}
  #end if
  #if str( $cutoff ) != ""
    --cutoff=$cutoff
  #else
    --cutoff=0
  #end if
  #if str( $number ) != ""
    --number=$number
  #end if
  --promoter_region=$promoter_start,$promoter_end
  --edge=$edge
  #if $features.set_feature_type
    --feature=$features.feature_type
  #end if
  --xls_file "$xls_out"
  #if $results_as_zip
    --zip_file "$zip_file"
  #else
    --output_files "$peaks_per_feature_out" "$features_per_peak_out"
    #if $output.compact_format
      --compact
    #else
      #if $output.summary
        --summary_files "$peaks_per_feature_summary" "$features_per_peak_summary"
      #end if
      ${output.pad_output}
    #end if
  #end if
  "${canonical_genes.fields.path}" "$peaks_in"
  ]]></command>
  <inputs>
    <param format="tabular" name="peaks_in" type="data" label="Peaks" />
    <param name="canonical_genes" type="select" label="Canonical genes to analyse ChIP peaks against">
      <options from_data_table="rnachipintegrator_canonical_genes">
      </options>
    </param>
    <expand macro="analysis_options" />
    <expand macro="output_options" />
  </inputs>
  <outputs>
    <!-- Always produce XLS output -->
    <data format="xls" name="xls_out"
	  label="All RnaChipIntegrator analyses: ${canonical_genes.fields.name} vs ${peaks_in.name} (Excel spreadsheet)" />
    <!-- Outputs if no zip requested -->
    <data format="tabular" name="peaks_per_feature_out"
	  label="Nearest peaks to each feature: ${canonical_genes.fields.name} vs ${peaks_in.name}" >
      <filter>results_as_zip is False</filter>
    </data>
    <data format="tabular" name="features_per_peak_out"
	  label="Nearest features to each peak: ${canonical_genes.fields.name} vs ${peaks_in.name}" >
      <filter>results_as_zip is False</filter>
    </data>
    <data format="tabular" name="peaks_per_feature_summary"
	  label="Nearest peaks to each feature (summary): ${canonical_genes.fields.name} vs ${peaks_in.name}" >
      <filter>results_as_zip is False</filter>
      <filter>output['compact_format'] is False</filter>
      <filter>output['summary'] is True</filter>
    </data>
    <data format="tabular" name="features_per_peak_summary"
	  label="Nearest features to each peak (summary): ${canonical_genes.fields.name} vs ${peaks_in.name}" >
      <filter>results_as_zip is False</filter>
      <filter>output['compact_format'] is False</filter>
      <filter>output['summary'] is True</filter>
    </data>
    <!-- All outputs in a ZIP file -->
    <data format="zip" name="zip_file"
	  label="All tab-delimited files for ${canonical_genes.fields.name} vs ${peaks_in.name} (zip file)" >
      <filter>results_as_zip is True</filter>
    </data>
  </outputs>
  <tests>
    <!--
	RnaChipIntegrator +name=mm9 +cutoff=50000 +xls +summary mm9_canonical_genes.tsv mm9_summits.txt
    -->
    <test>
      <param name="peaks_in" value="mm9_summits.txt" ftype="tabular" />
      <param name="canonical_genes" value="mm9_test" />
      <param name="cutoff" value="50000" />
      <output name="xls_out" file="mm9_summits.xls" compare="sim_size" />
      <output name="peaks_per_feature_out" ftype="tabular"
	      file="mm9_summits_per_feature.out" />
      <output name="features_per_peak_out" ftype="tabular"
	      file="mm9_features_per_summit.out" />
    </test>
    <!--
	RnaChipIntegrator +name=mm9 +cutoff=50000 +xls +compact mm9_canonical_genes.tsv mm9_peaks.txt
    -->
    <test>
      <param name="peaks_in" value="mm9_peaks.txt" ftype="tabular" />
      <param name="canonical_genes" value="mm9_test" />
      <param name="cutoff" value="50000" />
      <output name="xls_out" file="mm9_peaks1.xls" compare="sim_size" />
      <output name="peaks_per_feature_out" ftype="tabular"
	      file="mm9_peaks_per_feature1.out" />
      <output name="features_per_peak_out" ftype="tabular"
	      file="mm9_features_per_peak1.out" />
    </test>
    <!--
	RnaChipIntegrator +name=mm9 +cutoff=50000 +feature=gene +xls +compact mm9_canonical_genes.tsv mm9_peaks.txt
    -->
    <test>
      <param name="peaks_in" value="mm9_peaks.txt" ftype="tabular" />
      <param name="canonical_genes" value="mm9_test" />
      <param name="cutoff" value="50000" />
      <param name="set_feature_type" value="true" />
      <param name="feature_type" value="gene" />
      <output name="xls_out" file="mm9_peaks2.xls" compare="sim_size" />
      <output name="peaks_per_feature_out" ftype="tabular"
	      file="mm9_peaks_per_feature2.out" />
      <output name="features_per_peak_out" ftype="tabular"
	      file="mm9_features_per_peak2.out" />
    </test>
    <!--
	RnaChipIntegrator +name=mm9 +cutoff=50000 +xls +summary +pad mm9_canonical_genes.tsv mm9_peaks.txt
    -->
    <test>
      <param name="peaks_in" value="mm9_peaks.txt" ftype="tabular" />
      <param name="canonical_genes" value="mm9_test" />
      <param name="cutoff" value="50000" />
      <param name="compact_format" value="false" />
      <param name="summary" value="true" />
      <param name="pad_output" value="true" />
      <output name="xls_out" file="mm9_peaks3.xls" compare="sim_size" />
      <output name="peaks_per_feature_out" ftype="tabular"
	      file="mm9_peaks_per_feature3.out" />
      <output name="features_per_peak_out" ftype="tabular"
	      file="mm9_features_per_peak3.out" />
      <output name="peaks_per_feature_summary" ftype="tabular"
	      file="mm9_peaks_per_feature3.summary" />
      <output name="features_per_peak_summary" ftype="tabular"
	      file="mm9_features_per_peak3.summary" />
    </test>
  </tests>
  <help>

.. class:: infomark

**What it does**

Performs integrated analyses of a set of peaks (e.g. ChIP data) against a
list of "canonical genes" for a specific organism and genome build,
identifying the nearest peaks to each canonical gene (and vice versa).

RnaChipIntegrator can be obtained from
http://fls-bioinformatics-core.github.com/RnaChipIntegrator/

-------------

.. class:: infomark

**Input**

The peak data must be in a tabular file with at least 3 columns of data
for each peak (one peak per line):

====== ========== ======================================================================
Column Name       Description
====== ========== ======================================================================
     1 chr        Chromosome name (must match one of those in expression data file)
     2 start      Start position of the peak 
     3 end        End position of the peak (start + 1 for summit data)
====== ========== ======================================================================

-------------

.. class:: infomark

**Outputs**

The key outputs from the tool are two lists compromising the nearest
peaks for each feature, and the nearest feature for each peak (one
dataset for each list).

There are two formats for reporting: "compact" and "full":

 * **Compact output** reports all the hits for each peak or feature on
   a single line of output;
 * **Full output** reports each peak/feature pair on a separate line
   (i.e. a multi-line output format).

In "full" output mode, additional options are available:

 * The output files can be "padded" with extra (empty) lines to ensure
   that there are always the same number of lines for each peak or
   feature, if fewer than the requested number of hits are found.
 * "Summary" datasets can also be requested, which include just the top
   peak reported for each feature (and vice versa).

In either mode these data will also be output in a single MS Excel file,
which contains one sheet per result set.

-------------

.. class:: informark

**More information**

It is recommended that you refer to the ``RnaChipIntegrator``
documentation for information on the contents of each output file:

* http://rnachipintegrator.readthedocs.org/en/latest/

-------------

.. class:: infomark

**Credits**

This Galaxy tool has been developed within the Bioinformatics Core Facility at the
University of Manchester. It runs the RnaChipIntegrator package which has also been
developed by this group, and is documented at
https://pypi.python.org/pypi/RnaChipIntegrator/

Please kindly acknowledge the Bioinformatics Core Facility if you use this tool.
  </help>
  <expand macro="citations" />
</tool>
