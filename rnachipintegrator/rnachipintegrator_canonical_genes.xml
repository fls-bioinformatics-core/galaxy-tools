<tool id="rnachipintegrator_canonical_genes" name="Analyse canonical genes against ChIP data" version="@VERSION@-0">
  <description>using RnaChipIntegrator</description>
  <macros>
    <import>rnachipintegrator_macros.xml</import>
  </macros>
  <expand macro="requirements" />
  <expand macro="version_command" />
  <command interpreter="bash"><![CDATA[
  rnachipintegrator_wrapper.sh
  #if $peaks_in.metadata.chromCol
    --peak_cols=${peaks_in.metadata.chromCol},${peaks_in.metadata.startCol},${peaks_in.metadata.endCol}
  #end if
  #if str( $cutoff ) != ""
    --cutoff=$cutoff
  #else
    --cutoff=0
  #end if
  #if str( $number ) != ""
    --number=$number
  #else
    --number=0
  #end if
  --promoter_region=$promoter_start,$promoter_end
  --edge=$edge
  #if $features.set_feature_type
    --feature=$features.feature_type
  #end if
  --xls_file "$xls_out"
  #if $results_as_zip
    --zip_file "$zip_file"
  #else
    --output_files "$peaks_per_feature_out" "$features_per_peak_out"
    #if str( $output.output_format ) == "full"
      --summary_files "$peaks_per_feature_summary" "$features_per_peak_summary"
      ${output.pad_output}
    #else
      --compact
    #end if
  #end if
  "${canonical_genes.fields.path}" "$peaks_in"
  ]]></command>
  <inputs>
    <param format="tabular" name="peaks_in" type="data" label="Peaks" />
    <param name="canonical_genes" type="select" label="Canonical genes to analyse ChIP peaks against">
      <options from_data_table="rnachipintegrator_canonical_genes">
      </options>
    </param>
    <expand macro="analysis_options" />
    <expand macro="output_options" />
  </inputs>
  <outputs>
    <!-- Always produce XLS output -->
    <data format="xls" name="xls_out"
	  label="All RnaChipIntegrator analyses: ${canonical_genes.fields.name} vs ${peaks_in.name} (Excel spreadsheet)" />
    <!-- Outputs if no zip requested -->
    <data format="tabular" name="peaks_per_feature_out"
	  label="Nearest peaks to each feature: ${canonical_genes.fields.name} vs ${peaks_in.name}" >
      <filter>results_as_zip is False</filter>
    </data>
    <data format="tabular" name="features_per_peak_out"
	  label="Nearest features to each peak: ${canonical_genes.fields.name} vs ${peaks_in.name}" >
      <filter>results_as_zip is False</filter>
    </data>
    <data format="tabular" name="peaks_per_feature_summary"
	  label="Nearest peaks to each feature (summary): ${canonical_genes.fields.name} vs ${peaks_in.name}" >
      <filter>results_as_zip is False</filter>
      <filter>output['output_format'] == "full"</filter>
    </data>
    <data format="tabular" name="features_per_peak_summary"
	  label="Nearest features to each peak (summary): ${canonical_genes.fields.name} vs ${peaks_in.name}" >
      <filter>results_as_zip is False</filter>
      <filter>output['output_format'] == "full"</filter>
    </data>
    <!-- All outputs in a ZIP file -->
    <data format="zip" name="zip_file"
	  label="All tab-delimited files for ${canonical_genes.fields.name} vs ${peaks_in.name} (zip file)" >
      <filter>results_as_zip is True</filter>
    </data>
  </outputs>
  <tests>
    <!--
	RnaChipIntegrator +name=mm9 +cutoff=50000 +xls +summary mm9_canonical_genes.tsv mm9_summits.txt
    -->
    <test>
      <param name="peaks_in" value="mm9_summits.txt" ftype="tabular" />
      <param name="canonical_genes" value="mm9_test" />
      <param name="cutoff" value="50000" />
      <output name="xls_out" file="mm9_summits.xls" compare="sim_size" />
      <output name="peaks_per_feature_out" ftype="tabular"
	      file="mm9_summits_per_feature.out" />
      <output name="features_per_peak_out" ftype="tabular"
	      file="mm9_features_per_summit.out" />
      <output name="peaks_per_feature_summary" ftype="tabular"
	      file="mm9_summits_per_feature.summary" />
      <output name="features_per_peak_summary" ftype="tabular"
	      file="mm9_features_per_summit.summary" />
    </test>
    <!--
	RnaChipIntegrator +name=mm9 +cutoff=50000 +xls +summary mm9_canonical_genes.tsv mm9_peaks.txt
    -->
    <test>
      <param name="peaks_in" value="mm9_peaks.txt" ftype="tabular" />
      <param name="canonical_genes" value="mm9_test" />
      <param name="cutoff" value="50000" />
      <output name="xls_out" file="mm9_peaks.xls" compare="sim_size" />
      <output name="peaks_per_feature_out" ftype="tabular"
	      file="mm9_peaks_per_feature.out" />
      <output name="features_per_peak_out" ftype="tabular"
	      file="mm9_features_per_peak.out" />
      <output name="peaks_per_feature_summary" ftype="tabular"
	      file="mm9_peaks_per_feature.summary" />
      <output name="features_per_peak_summary" ftype="tabular"
	      file="mm9_features_per_peak.summary" />
    </test>
    <!--
	RnaChipIntegrator +name=mm9 +cutoff=50000 +feature=gene +xls +compact mm9_canonical_genes.tsv mm9_peaks.txt
    -->
    <test>
      <param name="peaks_in" value="mm9_peaks.txt" ftype="tabular" />
      <param name="canonical_genes" value="mm9_test" />
      <param name="cutoff" value="50000" />
      <param name="set_feature_type" value="true" />
      <param name="feature_type" value="gene" />
      <param name="output_format" value="compact" />
      <output name="xls_out" file="mm9_peaks_compact.xls" compare="sim_size" />
      <output name="peaks_per_feature_out" ftype="tabular"
	      file="mm9_peaks_per_feature_compact.out" />
      <output name="features_per_peak_out" ftype="tabular"
	      file="mm9_features_per_peak_compact.out" />
    </test>
  </tests>
  <help>

.. class:: infomark

**What it does**

Performs integrated analyses of a set of peaks (e.g. ChIP data) against a
list of "canonical genes" for a specific organism and genome build,
identifying the nearest peaks to each canonical gene (and vice versa).

RnaChipIntgerator can be obtained from
http://fls-bioinformatics-core.github.com/RnaChipIntegrator/

-------------

.. class:: infomark

**Input**

The peak data must be in a tabular file with at least 3 columns of data
for each peak (one peak per line):

====== ========== ======================================================================
Column Name       Description
====== ========== ======================================================================
     1 chr        Chromosome name (must match one of those in expression data file)
     2 start      Start position of the peak 
     3 end        End position of the peak (start + 1 for summit data)
====== ========== ======================================================================

-------------

.. class:: infomark

**Outputs**

The key outputs from the tool are two lists compromising the nearest
peaks for each feature, and the nearest feature for each peak (one
dataset for each list).

There are two formats for reporting: "full" and "compact":

 * **Full output** reports the most extensive data for each feature-peak
   pair, with one pair reported per line in the output datasets.
 * **Compact output** reports minimal data, with multiple peaks for a
   given feature on a single line (and vice versa).

In "full" output mode, "summary" datasets are also produced with just
the top peak reported for each feature (and vice versa).

In either mode these data will also be output in a single MS Excel file,
which contains one sheet per result set.

-------------

.. class:: informark

**More information**

It is recommended that you refer to the ``RnaChipIntegrator``
documentation for information on the contents of each output file:
https://github.com/fls-bioinformatics-core/RnaChipIntegrator/blob/master/doc/MANUAL.markdown

-------------

.. class:: infomark

**Credits**

This Galaxy tool has been developed within the Bioinformatics Core Facility at the
University of Manchester. It runs the RnaChipIntegrator package which has also been
developed by this group, and is documented at
http://fls-bioinformatics-core.github.com/RnaChipIntegrator/

Please kindly acknowledge the Bioinformatics Core Facility if you use this tool.
  </help>
  <expand macro="citations" />
</tool>
